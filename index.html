<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clinica Cavallieri</title>
    <script src="dados.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        body { margin: 0; font-family: 'Segoe UI', Arial, sans-serif; background: #0b132b; color: #fff; }
        .header-container { display: flex; justify-content: space-between; align-items: center; padding: 15px 25px; background: #111a3a; border-bottom: 2px solid #3a86ff; }
        .main-title-banner { 
            background: linear-gradient(90deg, #111a3a 0%, #3a86ff 50%, #111a3a 100%);
            text-align: center; padding: 15px; font-size: 28px; font-weight: 900; 
            letter-spacing: 2px; text-transform: uppercase; border-bottom: 1px solid #4cc9f0;
        }
        .filters { padding: 15px 20px; background: #141e46; display: flex; flex-direction: column; gap: 12px; }
        .filter-row { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
        button { padding: 8px 16px; border: none; border-radius: 8px; background: #1c2541; color: #fff; cursor: pointer; font-weight: bold; border: 1px solid #3a86ff; transition: 0.3s; }
        button.active { background-color: #3a86ff !important; box-shadow: 0 0 10px rgba(58, 134, 255, 0.5); }
        select { padding: 6px; border-radius: 4px; background: #1c2541; color: white; border: 1px solid #3a86ff; }
        
        .cardbar { display: flex; gap: 10px; padding: 10px; }
        .card { flex: 1; background: #1c2541; padding: 15px; border-radius: 10px; text-align: center; border-bottom: 3px solid #3a86ff; }
        .big { font-size: 24px; font-weight: bold; color: #4cc9f0; }
        
        .container { display: flex; gap: 10px; padding: 10px; min-height: 480px; }
        .left, .right { 
            flex: 1; 
            background: #1c2541; 
            padding: 15px; 
            border-radius: 10px; 
            min-width: 0;
            display: flex;
            flex-direction: column;
        }
        
        table { width: 100%; border-collapse: collapse; font-size: 11px; }
        th { padding: 8px; background: #111a3a; color: #3a86ff; }
        td, th { border: 1px solid #2a3b6b; text-align: center; }
        #calendar td { height: 85px; vertical-align: middle; position: relative; width: 14.2%; }
        .day { position: absolute; top: 4px; left: 6px; font-weight: bold;}
        .cell-content { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%; }

        /* Ajuste para o Canvas preencher o espaço */
        canvas { flex-grow: 1; width: 100% !important; }

        @media (max-width: 768px) {
            .main-title-banner { font-size: 18px; padding: 10px; }
            .cardbar { display: grid; grid-template-columns: 1fr 1fr; }
            .container { flex-direction: column; }
            #calendar td { height: 60px; font-size: 9px; }
        }
    </style>
</head>
<body>

<div class="header-container">
    <div style="font-weight: bold; color: #3a86ff; font-size: 20px;">Clinica Cavallieri</div>
</div>

<div class="main-title-banner" id="tituloPrincipal">DASHBOARD DE PERFORMANCE</div>

<div class="filters">
    <div class="filter-row">
        <span>Período:</span>
        <select id="anoFiltro"></select>
        <select id="mesFiltro">
            <option value="1">Janeiro</option><option value="2" selected>Fevereiro</option><option value="3">Março</option>
            <option value="4">Abril</option><option value="5">Maio</option><option value="6">Junho</option>
            <option value="7">Julho</option><option value="8">Agosto</option><option value="9">Setembro</option>
            <option value="10">Outubro</option><option value="11">Novembro</option><option value="12">Dezembro</option>
        </select>
    </div>
    <div class="filter-row" id="grupoBotoes">
        <span>Salas:</span>
        <button class="active" onclick="setSala('ALL', this)">VISÃO GERAL</button>
        <button onclick="setSala('306', this)">306</button>
        <button onclick="setSala('307', this)">307</button>
        <button onclick="setSala('313', this)">313</button>
        <button onclick="setSala('602', this)">602</button>
        <button onclick="setSala('606', this)">606</button>
    </div>
</div>

<div class="cardbar">
    <div class="card"><div class="big" id="att">0</div>Atendimentos</div>
    <div class="card"><div class="big" id="occ">0%</div>Ocupação</div>
    <div class="card"><div class="big" id="rec">R$ 0</div>Receita</div>
    <div class="card"><div class="big" id="ticket">R$ 0</div>Ticket médio</div>
</div>

<div class="container">
    <div class="left">
        <b id="tituloEsquerdo">Detalhes</b>
        <table id="calendar"></table>
        <div style="flex-grow:1; position: relative;">
            <canvas id="chartCapacidade" style="display:none;"></canvas>
        </div>
    </div>
    <div class="right">
        <b id="tituloDireito">Análise de Dados</b>
        <div style="flex-grow:1; min-height: 300px; position: relative;">
            <canvas id="chartRight"></canvas>
        </div>
    </div>
</div>

<script>
let data = [];
let salaFiltro = "ALL";
let chartRight, chartCapacidade;
const capacidade = { "306": 38, "307": 30, "313": 20, "602": 40, "606": 40 };
const nomesMeses = ["", "Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];

Chart.register(ChartDataLabels);

window.onload = function() {
    if (typeof DATA_CSV !== 'undefined') {
        parseCSV(DATA_CSV);
        carregarAnos();
        render();
    }
};

function parseCSV(text) {
    let lines = text.split("\n");
    let headers = lines[0].split(";").map(h => h.trim());
    data = [];
    for (let i = 1; i < lines.length; i++) {
        if (!lines[i].trim()) continue;
        let cols = lines[i].split(";");
        let obj = {};
        headers.forEach((h, j) => obj[h] = cols[j] ? cols[j].trim() : "");
        data.push(obj);
    }
}

function carregarAnos() {
    let anos = [...new Set(data.map(d => d.ANO))].sort();
    let sel = document.getElementById("anoFiltro");
    sel.innerHTML = "";
    anos.forEach(a => {
        let op = document.createElement("option");
        op.value = a; op.text = a; 
        if(a == 2026) op.selected = true;
        sel.appendChild(op);
    });
}

document.getElementById("anoFiltro").onchange = render;
document.getElementById("mesFiltro").onchange = render;

function setSala(sala, btn) {
    salaFiltro = sala;
    document.querySelectorAll('#grupoBotoes button').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    render();
}

function num(v) {
    if (!v) return 0;
    return parseFloat(String(v).replace("R$", "").replace(/\./g, "").replace(",", ".").trim()) || 0;
}

function render() {
    let ano = document.getElementById("anoFiltro").value;
    let mes = document.getElementById("mesFiltro").value;
    if(!ano || !mes) return;

    document.getElementById("tituloPrincipal").innerText = `${salaFiltro === "ALL" ? "GERAL" : "SALA " + salaFiltro} | ${nomesMeses[mes]} ${ano}`;

    let filtered = data.filter(d => d.ANO == ano && d.MES == mes && (salaFiltro == "ALL" || d.SALA_FINAL == salaFiltro));
    let atend = filtered.length;
    let receita = filtered.reduce((a, b) => a + num(b.VALOR), 0);
    let diasUnicos = [...new Set(filtered.map(d => d.DATA))].length || 1;
    let capTotal = (salaFiltro === "ALL") ? Object.values(capacidade).reduce((a,b)=>a+b,0) * diasUnicos : (capacidade[salaFiltro] || 0) * diasUnicos;

    document.getElementById("att").innerText = `${atend} / ${capTotal}`;
    document.getElementById("rec").innerText = "R$ " + receita.toLocaleString("pt-BR");
    document.getElementById("occ").innerText = capTotal ? ((atend/capTotal)*100).toFixed(1) + "%" : "0%";
    document.getElementById("ticket").innerText = "R$ " + (atend ? (receita/atend).toLocaleString("pt-BR", {maximumFractionDigits: 0}) : "0");

    if (salaFiltro === "ALL") {
        document.getElementById("calendar").style.display = "none";
        document.getElementById("chartCapacidade").style.display = "block";
        document.getElementById("tituloEsquerdo").innerText = "Ocupação por Sala";
        document.getElementById("tituloDireito").innerText = "Receita por Sala";
        buildChartCapacidade(filtered, diasUnicos);
        buildChartReceita(filtered);
    } else {
        document.getElementById("calendar").style.display = "table";
        document.getElementById("chartCapacidade").style.display = "none";
        document.getElementById("tituloEsquerdo").innerText = "Calendário de Ocupação";
        document.getElementById("tituloDireito").innerText = "Histórico Regressivo";
        buildCalendar(filtered);
        buildChartTrendBars(salaFiltro, ano, mes);
    }
}

// CORREÇÃO: Histórico Regressivo com barras na base e cores fixas
function buildChartTrendBars(sala, ano, mesRef) {
    let m = parseInt(mesRef);
    let a = parseInt(ano);
    let periodos = [];
    for(let i=0; i<3; i++) {
        let tempM = m - i;
        let tempA = a;
        if(tempM <= 0) { tempM += 12; tempA -= 1; }
        periodos.push({ m: tempM, a: tempA });
    }

    let stats = periodos.reverse().map(p => {
        let f = data.filter(d => d.SALA_FINAL === sala && d.MES == p.m && d.ANO == p.a);
        let rec = f.reduce((acc, b) => acc + num(b.VALOR), 0);
        let dias = [...new Set(f.map(d => d.DATA))].length || 1;
        let cap = dias * (capacidade[sala] || 30);
        let ocup = cap ? (f.length / cap) * 100 : 0;
        return { label: `${nomesMeses[p.m].substring(0,3)}/${String(p.a).substring(2)}`, rec, ocup };
    });

    if (chartRight) chartRight.destroy();
    chartRight = new Chart(document.getElementById("chartRight"), {
        type: 'bar',
        data: {
            labels: stats.map(s => s.label),
            datasets: [
                { label: 'Receita', data: stats.map(s => s.rec), backgroundColor: '#3a86ff', yAxisID: 'y' },
                { label: 'Ocupação %', data: stats.map(s => s.ocup), backgroundColor: '#f2c94c', yAxisID: 'y1' }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true, display: false },
                y1: { beginAtZero: true, max: 100, display: false },
                x: { grid: { display: false }, ticks: { color: '#fff' } }
            },
            plugins: {
                legend: { labels: { color: '#fff' } },
                datalabels: {
                    color: '#fff',
                    font: { weight: 'bold' },
                    formatter: (v, ctx) => ctx.datasetIndex === 1 ? v.toFixed(0)+'%' : 'R$ '+(v/1000).toFixed(0)+'k'
                }
            }
        }
    });
}

// CORREÇÃO: Ocupação por Sala com eixos corrigidos
function buildChartCapacidade(dados, dias) {
    let stats = {};
    Object.keys(capacidade).forEach(s => stats[s] = { atend: 0, cap: capacidade[s] * dias });
    dados.forEach(d => { if(stats[d.SALA_FINAL]) stats[d.SALA_FINAL].atend++; });
    const labels = Object.keys(stats);
    
    if (chartCapacidade) chartCapacidade.destroy();
    chartCapacidade = new Chart(document.getElementById("chartCapacidade"), {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{ 
                data: labels.map(s => stats[s].atend), 
                backgroundColor: labels.map(s => {
                    let p = (stats[s].atend / stats[s].cap) * 100;
                    return p >= 70 ? '#1faa59' : p >= 50 ? '#f2c94c' : '#eb5757';
                })
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { 
                y: { beginAtZero: true, grid: { color: '#2a3b6b' }, ticks: { color: '#fff' } },
                x: { ticks: { color: '#fff' } }
            },
            plugins: { 
                legend: { display: false }, 
                datalabels: { 
                    align: 'top', anchor: 'end', color: '#fff',
                    formatter: (v, ctx) => `${v}\n(${((v/stats[ctx.chart.data.labels[ctx.dataIndex]].cap)*100).toFixed(0)}%)`
                } 
            }
        }
    });
}

// CORREÇÃO: Receita por Sala com proporcionalidade visual
function buildChartReceita(dados) {
    let recs = {};
    Object.keys(capacidade).forEach(s => recs[s] = 0);
    dados.forEach(d => { if(recs[d.SALA_FINAL] !== undefined) recs[d.SALA_FINAL] += num(d.VALOR); });
    
    if (chartRight) chartRight.destroy();
    chartRight = new Chart(document.getElementById("chartRight"), {
        type: "bar",
        data: {
            labels: Object.keys(recs),
            datasets: [{ data: Object.values(recs), backgroundColor: '#3a86ff' }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { 
                y: { beginAtZero: true, display: false },
                x: { ticks: { color: '#fff' } }
            },
            plugins: { 
                legend: { display: false }, 
                datalabels: { 
                    align: 'top', anchor: 'end', color: '#fff', 
                    formatter: (v) => 'R$ ' + (v/1000).toFixed(1) + 'k' 
                } 
            }
        }
    });
}

function buildCalendar(dataCal) {
    let cal = document.getElementById("calendar"); cal.innerHTML = "";
    let diasSem = ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "Sab"];
    cal.innerHTML += "<tr>" + diasSem.map(d => `<th>${d}</th>`).join("") + "</tr>";
    if (!dataCal.length) return;
    let ano = parseInt(dataCal[0].ANO), mes = parseInt(dataCal[0].MES);
    let diasMes = new Date(ano, mes, 0).getDate();
    let primDia = new Date(ano, mes - 1, 1).getDay();
    let porData = {};
    dataCal.forEach(d => {
        if (!porData[d.DATA]) porData[d.DATA] = { qtd: 0, rec: 0, sala: d.SALA_FINAL };
        porData[d.DATA].qtd++; porData[d.DATA].rec += num(d.VALOR);
    });
    let row = "<tr>";
    for (let i = 0; i < primDia; i++) row += "<td style='background:#111a3a'></td>";
    for (let d = 1; d <= diasMes; d++) {
        let key = Object.keys(porData).find(k => parseInt(k.split("/")[0]) === d);
        let cl = "#1c2541", cont = `<div class="day">${d}</div>`;
        if (key) {
            let pct = (porData[key].qtd/capacidade[porData[key].sala])*100;
            cl = pct >= 70 ? "#1faa59" : pct >= 50 ? "#f2c94c" : "#eb5757";
            cont += `<div class="cell-content" style="color:${pct >= 50 && pct < 70 ? '#000' : '#fff'}">
                        <div style="font-weight:bold">${porData[key].qtd}/${capacidade[porData[key].sala]}</div>
                        <div style="font-size:10px">R$ ${porData[key].rec.toLocaleString("pt-BR")}</div>
                     </div>`;
        }
        row += `<td style="background:${cl}">${cont}</td>`;
        if ((primDia + d) % 7 === 0) row += "</tr><tr>";
    }
    cal.innerHTML += row + "</tr>";
}
</script>
</body>
</html>